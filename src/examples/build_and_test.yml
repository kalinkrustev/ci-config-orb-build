description: >
  Build and publish nodejs projects to npm and docker.
usage:
  version: 2.1

  orbs:
    build: mojaloop/build@1.0.0

  workflows:
    build_and_test:
      jobs:
        - pr-tools/pr-title-check:
            context: org-global
        - build/setup:
            context: org-global
            filters:
              tags:
                only: /.*/
              branches:
                ignore:
                  - /feature*/
                  - /bugfix*/
        - build/test_dependencies:
            context: org-global
            requires:
              - build/setup
            filters:
              tags:
                ignore: /.*/
              branches:
                ignore:
                  - main
        - build/test_lint:
            context: org-global
            requires:
              - build/setup
            filters:
              tags:
                only: /.*/
              branches:
                ignore:
                  - /feature*/
                  - /bugfix*/
        - build/test_unit:
            context: org-global
            requires:
              - build/setup
            filters:
              tags:
                only: /.*/
              branches:
                ignore:
                  - /feature*/
                  - /bugfix*/
        - build/test_coverage:
            context: org-global
            requires:
              - build/setup
            filters:
              tags:
                only: /.*/
              branches:
                ignore:
                  - /feature*/
                  - /bugfix*/
        - build/test_integration:
            context: org-global
            requires:
              - build/setup
              - build/build_local
            filters:
              tags:
                only: /.*/
              branches:
                ignore:
                  - /feature*/
                  - /bugfix*/
        - build/test_functional:
            context: org-global
            requires:
              - build/setup
              - build/build_local
            filters:
              tags:
                only: /.*/
              branches:
                ignore:
                  - /feature*/
                  - /bugfix*/
        - build/vulnerability_check:
            context: org-global
            requires:
              - build/setup
            filters:
              tags:
                only: /.*/
              branches:
                ignore:
                  - /feature*/
                  - /bugfix*/
        - build/audit_licenses:
            context: org-global
            requires:
              - build/setup
            filters:
              tags:
                only: /.*/
              branches:
                ignore:
                  - /feature*/
                  - /bugfix*/
        - build/build_local:
            context: org-global
            requires:
              - build/setup
            filters:
              tags:
                only: /.*/
              branches:
                ignore:
                  - /feature*/
                  - /bugfix*/
        - build/license_scan:
            context: org-global
            requires:
              - build/build_local
            filters:
              tags:
                only: /v[0-9]+(\.[0-9]+)*(\-snapshot(\.[0-9]+)?)?(\-hotfix(\.[0-9]+)?)?(\-perf(\.[0-9]+)?)?/
              branches:
                ignore:
                  - /.*/
        - build/image_scan:
            context: org-global
            requires:
              - build/build_local
            filters:
              tags:
                only: /v[0-9]+(\.[0-9]+)*(\-snapshot(\.[0-9]+)?)?(\-hotfix(\.[0-9]+)?)?(\-perf(\.[0-9]+)?)?/
              branches:
                ignore:
                  - /.*/
        # New commits to main release automatically
        - build/release:
            context: org-global
            requires:
              - pr-tools/pr-title-check
              - build/test_lint
              - build/test_unit
              - build/test_coverage
              - build/test_integration
              - build/test_functional
              - build/vulnerability_check
              - build/audit_licenses
              - build/license_scan
              - build/image_scan
            filters:
              branches:
                only:
                  - main
                  - master
                  - /release\/v.*/
        - build/github_release:
            context: org-global
            requires:
              - build/release
            filters:
              branches:
                only:
                  - main
                  - /release\/v.*/
        - build/publish_docker:
            context: org-global
            requires:
              - build/build_local
              - pr-tools/pr-title-check
              - build/test_lint
              - build/test_unit
              - build/test_coverage
              - build/test_integration
              - build/test_functional
              - build/vulnerability_check
              - build/audit_licenses
              - build/license_scan
              - build/image_scan
            filters:
              tags:
                only: /v[0-9]+(\.[0-9]+)*/
              branches:
                ignore:
                  - /.*/
        - build/publish_docker-snapshot:
            context: org-global
            requires:
              - build/build_local
              - pr-tools/pr-title-check
              - build/test_lint
              - build/test_unit
              - build/test_coverage
              - build/test_integration
              - build/test_functional
              - build/vulnerability_check
              - build/audit_licenses
              - build/license_scan
              - build/image_scan
            filters:
              tags:
                only: /v[0-9]+(\.[0-9]+)*\-snapshot+((\.[0-9]+)?)/
              branches:
                ignore:
                  - /.*/
        - build/publish_npm:
            context: org-global
            requires:
              - pr-tools/pr-title-check
              - build/test_lint
              - build/test_unit
              - build/test_coverage
              - build/test_integration
              - build/test_functional
              - build/vulnerability_check
              - build/audit_licenses
              - build/license_scan
              - build/image_scan
            filters:
              tags:
                only: /v[0-9]+(\.[0-9]+)*/
              branches:
                ignore:
                  - /.*/
        - build/publish_npm-snapshot:
            context: org-global
            requires:
              - pr-tools/pr-title-check
              - build/test_lint
              - build/test_unit
              - build/test_coverage
              - build/test_integration
              - build/test_functional
              - build/vulnerability_check
              - build/audit_licenses
              - build/license_scan
              - build/image_scan
            filters:
              tags:
                only: /v[0-9]+(\.[0-9]+)*\-snapshot+((\.[0-9]+)?)/
              branches:
                ignore:
                  - /.*/
        - build/publish_prerelease:
            context: org-global
            requires:
              - pr-tools/pr-title-check
              - build/test_lint
              - build/test_unit
              - build/test_coverage
              - build/vulnerability_check
              - build/audit_licenses
            filters:
              branches:
                only:
                  - /(major|minor|patch)/.*/
